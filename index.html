<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصنع السلطة - توزيع الجداول على صفحتين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* إعادة تعيين كل الهوامش والمسافات */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            direction: ltr;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }

        /* Header Styles */
        .header {
            background-color: #2E5E3A;
            color: white;
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #E6B905;
            color: #2E5E3A;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-btn:hover {
            background: #d4a900;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-bottom: 2px solid #ccc;
            position: sticky;
            top: 48px;
            z-index: 999;
        }

        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .nav-tab.active {
            border-bottom-color: #2E5E3A;
            color: #2E5E3A;
        }

        .nav-tab:hover {
            background-color: rgba(46, 94, 58, 0.05);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 90px);
            overflow: hidden;
        }

        /* Print Controls */
        .print-controls {
            background-color: white;
            padding: 8px 12px;
            margin: 5px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 2px solid #eee;
        }

        .print-btn {
            background: #2E5E3A;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .print-btn:hover {
            background: #1e4a2a;
        }

        .print-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Filter Section */
        .filter-section {
            background-color: white;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-bottom: 2px solid #eee;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #2E5E3A;
            margin-bottom: 3px;
        }

        .branch-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #8B9E7E;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
        }

        .branch-select:focus {
            outline: none;
            border-color: #2E5E3A;
        }

        /* Data Container */
        .data-container {
            flex: 1;
            overflow: auto;
            padding: 5px;
        }

        /* تقسيم الصفحة إلى عمودين */
        .split-view {
            display: flex;
            gap: 10px;
            height: 100%;
        }

        .column {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            background-color: #2E5E3A;
            color: white;
            padding: 4px 8px;
            font-weight: 700;
            font-size: 13px;
            text-align: center;
            border-radius: 4px 4px 0 0;
            margin-bottom: 2px;
        }

        .column-content {
            overflow-y: auto;
            padding: 0;
            flex: 1;
        }

        /* ===== أنماط الجداول ===== */
        .card {
            background-color: white;
            border: 1px solid #000;
            border-radius: 0;
            margin: 0;
            padding: 0;
            border-top-width: 1px;
            border-bottom-width: 0;
        }
        
        .card {
            border-bottom: none;
        }
        
        .column-content .card:last-child {
            border-bottom: 1px solid #000;
        }
        
        .card + .card {
            margin-top: -1px;
            border-top: 1px solid #000;
        }
        
        .card-header, .card-body {
            margin: 0;
            padding: 0;
        }

        .card-header {
            background-color: #d0d8d0;
            padding: 2px 4px;
            font-weight: 700;
            font-size: 12px;
            color: #000;
            text-align: center;
            border-bottom: 1px solid #000;
            margin: 0;
        }

        .card-body {
            padding: 0;
            margin: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 0;
            padding: 0;
        }

        .production-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 11px;
            line-height: 1.1;
            margin: 0;
            padding: 0;
        }

        .production-table th,
        .production-table td {
            border: 1px solid #000;
            padding: 1px 2px;
            margin: 0;
            text-align: center;
            vertical-align: middle;
            font-size: 11px;
            font-weight: 400;
        }

        .production-table th:first-child,
        .production-table td:first-child {
            text-align: left;
            padding: 1px 2px;
            width: 35%;
            white-space: normal;
            word-wrap: break-word;
        }

        .production-table th {
            background-color: #e0e0e0;
            font-weight: 600;
            color: #000;
            white-space: nowrap;
            padding: 2px 2px;
        }

        .total-cell {
            background-color: #d0d0d0;
            font-weight: 600;
        }

        .product-name {
            font-weight: 500;
            line-height: 1.1;
            white-space: normal;
            word-wrap: break-word;
            font-size: 11px;
        }

        .product-package {
            font-size: 9px;
            color: #555;
            line-height: 1;
        }

        /* ===== أنماط الطباعة - توزيع على صفحتين ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
                margin: 0;
                padding: 0;
                direction: ltr;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .main-content {
                height: auto;
                overflow: visible;
            }
            
            .data-container {
                overflow: visible;
                padding: 0;
                margin: 0;
            }
            
            .split-view {
                display: flex;
                gap: 3mm;
                page-break-after: avoid;
                margin: 0;
                padding: 0;
            }
            
            .column {
                flex: 1;
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
            }
            
            .column-content {
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
            }
            
            .column-header {
                font-size: 12px;
                padding: 2px 4px;
                margin: 0;
                page-break-after: avoid;
                background-color: #2E5E3A !important;
                color: white !important;
                font-weight: 700;
            }
            
            .card {
                border: 0.5px solid black !important;
                margin: 0;
                padding: 0;
                border-radius: 0;
                page-break-inside: avoid;
                border-top-width: 0.5px;
                border-bottom-width: 0;
            }
            
            .card + .card {
                margin-top: -0.5px;
                border-top: 0.5px solid black !important;
            }
            
            .column-content .card:last-child {
                border-bottom: 0.5px solid black !important;
            }
            
            .card-header {
                padding: 1px 2px;
                font-size: 11px;
                border-bottom: 0.5px solid black !important;
                background-color: #d0d8d0 !important;
                color: black !important;
                font-weight: 600;
                margin: 0;
            }
            
            .production-table {
                font-size: 10px !important;
                border-collapse: collapse;
                margin: 0;
                padding: 0;
            }
            
            .production-table th,
            .production-table td {
                border: 0.5px solid black !important;
                padding: 1px 1px !important;
                font-size: 10px !important;
                font-weight: 400;
                margin: 0;
            }
            
            .production-table th {
                background-color: #e0e0e0 !important;
                font-weight: 600 !important;
                color: black !important;
                padding: 1px 1px !important;
            }
            
            .product-name {
                font-size: 10px !important;
                font-weight: 500 !important;
            }
            
            .product-package {
                font-size: 8px !important;
                color: #333 !important;
            }
            
            .total-cell {
                background-color: #d0d0d0 !important;
                font-weight: 600 !important;
            }
            
            .print-page {
                page-break-after: always;
                margin: 0;
                padding: 0;
            }
            
            /* منع التقسيم داخل الصفحة الواحدة */
            .column-content, .card, .card-body, .table-container, 
            .production-table, tbody, tr, td, th {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }
            
            @page {
                size: A4 landscape;
                margin: 3mm;
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 10px;
        }

        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(46, 94, 58, 0.2);
            border-left: 3px solid #2E5E3A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 8px 12px;
            margin: 5px 0;
            font-size: 14px;
            border-radius: 5px;
        }

        .success-message { 
            background: #efe; 
            color: #363; 
            border: 1px solid #cfc; 
        }
        
        .error-message { 
            background: #fee; 
            color: #c33; 
            border: 1px solid #fcc; 
        }
        
        .warning-message { 
            background: #ffecb5; 
            color: #7d6608; 
            border: 1px solid #ffd54f; 
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8B9E7E;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2E5E3A;
        }

        .table-container {
            line-height: 0;
            font-size: 0;
        }
        
        .table-container table {
            line-height: normal;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="container">
            <div class="header-content">
                <button id="refresh-btn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> <span>تحديث البيانات</span>
                </button>
            </div>
        </div>
    </header>

    <div class="nav-tabs no-print">
        <div class="nav-tab active" data-tab="production">
            <i class="fas fa-industry"></i> <span>الإنتاج</span>
        </div>
        <div class="nav-tab" data-tab="supply">
            <i class="fas fa-truck-loading"></i> <span>توريد</span>
        </div>
    </div>

    <main class="container">
        <div id="production-tab" class="tab-content">
            <div class="main-content">
                <div class="print-controls no-print">
                    <button id="print-all-production" class="print-btn">
                        <i class="fas fa-print"></i> طباعة الكل (صفحتين)
                    </button>
                    <button id="load-sample-production" class="print-btn" style="background:#8B9E7E;">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>

                <div class="filter-section no-print">
                    <label class="filter-label">الفرع:</label>
                    <select id="branch-filter-production" class="branch-select">
                        <option value="">كل الفروع</option>
                    </select>
                </div>

                <div id="message-container-production"></div>

                <div class="data-container" id="scroll-container-production">
                    <div id="loading-state-production" class="loading-spinner">
                        <div class="spinner"></div>
                        <span>جاري تحميل بيانات الإنتاج...</span>
                    </div>

                    <div id="empty-state-production" class="empty-state hidden">
                        <div class="empty-icon"><i class="fas fa-industry"></i></div>
                        <h3>لا توجد بيانات</h3>
                        <button id="try-sample-production" class="print-btn" style="margin-top:5px;">عرض بيانات تجريبية</button>
                    </div>

                    <div id="production-data" class="hidden"></div>
                </div>
            </div>
        </div>

        <div id="supply-tab" class="tab-content hidden">
            <div class="main-content">
                <div class="print-controls no-print">
                    <button id="print-all-supply" class="print-btn">
                        <i class="fas fa-print"></i> طباعة الكل (صفحتين)
                    </button>
                    <button id="load-sample-supply" class="print-btn" style="background:#8B9E7E;">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>

                <div class="filter-section no-print">
                    <label class="filter-label">الفرع:</label>
                    <select id="branch-filter-supply" class="branch-select">
                        <option value="">كل الفروع</option>
                    </select>
                </div>

                <div id="message-container-supply"></div>

                <div class="data-container" id="scroll-container-supply">
                    <div id="loading-state-supply" class="loading-spinner">
                        <div class="spinner"></div>
                        <span>جاري تحميل بيانات التوريد...</span>
                    </div>

                    <div id="empty-state-supply" class="empty-state hidden">
                        <div class="empty-icon"><i class="fas fa-truck-loading"></i></div>
                        <h3>لا توجد بيانات</h3>
                        <button id="try-sample-supply" class="print-btn" style="margin-top:5px;">عرض بيانات تجريبية</button>
                    </div>

                    <div id="supply-data" class="hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let appState = {
            currentTab: 'production',
            production: {
                items: [],
                filteredItems: [],
                allBranches: [],
                selectedBranch: '',
                apiUrl: 'https://ramadanv2026-production.up.railway.app/api/orderProduction/getOrderPof2Days',
                isLoading: false
            },
            supply: {
                items: [],
                filteredItems: [],
                allBranches: [],
                selectedBranch: '',
                apiUrl: 'https://ramadanv2026-production.up.railway.app/api/orderSupply/getOrderPof2Days',
                isLoading: false
            }
        };

        const BRANCH_ORDER = ['M', 'S', 'A'];
        const BRANCH_NAMES = {
            'M': 'شوران M',
            'S': 'سلطنة S',
            'A': 'عزيزية A'
        };

        function sortBranches(branches) {
            return branches.sort((a, b) => {
                let codeA = a.charAt(0);
                let codeB = b.charAt(0);
                let indexA = BRANCH_ORDER.indexOf(codeA);
                let indexB = BRANCH_ORDER.indexOf(codeB);
                if (indexA === -1) indexA = BRANCH_ORDER.length;
                if (indexB === -1) indexB = BRANCH_ORDER.length;
                return indexA - indexB;
            });
        }

        $(document).ready(function() {
            loadProductionData();
            setupEventListeners();
        });

        function setupEventListeners() {
            $('.nav-tab').click(function() {
                let tab = $(this).data('tab');
                $('.nav-tab').removeClass('active');
                $(this).addClass('active');
                $('.tab-content').addClass('hidden');
                $(`#${tab}-tab`).removeClass('hidden');
                appState.currentTab = tab;
            });

            $('#branch-filter-production').change(function() {
                appState.production.selectedBranch = $(this).val() || '';
                filterItems('production');
            });

            $('#branch-filter-supply').change(function() {
                appState.supply.selectedBranch = $(this).val() || '';
                filterItems('supply');
            });

            $('#refresh-btn').click(function() {
                if (appState.currentTab === 'production') {
                    loadProductionData();
                } else {
                    loadSupplyData();
                }
            });

            $('#load-sample-production, #try-sample-production').click(function() {
                loadSampleProductionData();
            });

            $('#load-sample-supply, #try-sample-supply').click(function() {
                loadSampleSupplyData();
            });

            $('#print-all-production').click(() => printAllTables('production'));
            $('#print-all-supply').click(() => printAllTables('supply'));
        }

        async function loadProductionData() {
            if (appState.production.isLoading) return;
            
            appState.production.isLoading = true;
            $('#loading-state-production').removeClass('hidden');
            $('#production-data').addClass('hidden');
            $('#empty-state-production').addClass('hidden');
            $('#refresh-btn').prop('disabled', true);

            try {
                try {
                    const response = await fetch(appState.production.apiUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 200 && data.data && data.data.length > 0) {
                            processProductionData(data);
                            showMessage('production', '✅ تم التحميل بنجاح', 'success');
                            return;
                        }
                    }
                } catch (e) {}

                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + appState.production.apiUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error();

                const data = await response.json();
                if (data.status === 200 && data.data && data.data.length > 0) {
                    processProductionData(data);
                    showMessage('production', '✅ تم التحميل بنجاح', 'success');
                } else {
                    $('#empty-state-production').removeClass('hidden');
                }
            } catch (error) {
                $('#empty-state-production').removeClass('hidden');
            } finally {
                appState.production.isLoading = false;
                $('#loading-state-production').addClass('hidden');
                $('#refresh-btn').prop('disabled', false);
            }
        }

        async function loadSupplyData() {
            if (appState.supply.isLoading) return;
            
            appState.supply.isLoading = true;
            $('#loading-state-supply').removeClass('hidden');
            $('#supply-data').addClass('hidden');
            $('#empty-state-supply').addClass('hidden');
            $('#refresh-btn').prop('disabled', true);

            try {
                try {
                    const response = await fetch(appState.supply.apiUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 200 && data.data && data.data.length > 0) {
                            processSupplyData(data);
                            showMessage('supply', '✅ تم التحميل بنجاح', 'success');
                            return;
                        }
                    }
                } catch (e) {}

                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + appState.supply.apiUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error();

                const data = await response.json();
                if (data.status === 200 && data.data && data.data.length > 0) {
                    processSupplyData(data);
                    showMessage('supply', '✅ تم التحميل بنجاح', 'success');
                } else {
                    $('#empty-state-supply').removeClass('hidden');
                }
            } catch (error) {
                $('#empty-state-supply').removeClass('hidden');
            } finally {
                appState.supply.isLoading = false;
                $('#loading-state-supply').addClass('hidden');
                $('#refresh-btn').prop('disabled', false);
            }
        }

        function loadSampleProductionData() {
            let sampleData = {
                data: [
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'نوسف غانم' }, package: '1500', packageUnit: { name: 'g' }, qty: 3, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'نوسف غانم' }, package: '1500', packageUnit: { name: 'g' }, qty: 2, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'نوسف غانم' }, package: '1500', packageUnit: { name: 'g' }, qty: 1, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'صابر غانم' }, package: '3000', packageUnit: { name: 'g' }, qty: 1, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'صابر غانم' }, package: '3000', packageUnit: { name: 'g' }, qty: 2, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# المقرمشات سنوي' }, product: { name: 'صابر غانم' }, package: '3000', packageUnit: { name: 'g' }, qty: 1, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# الصوصات شامية' }, product: { name: 'إيطالي سلف' }, package: '700', packageUnit: { name: 'g' }, qty: 7, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# الصوصات شامية' }, product: { name: 'ديس رمان' }, package: '800', packageUnit: { name: 'g' }, qty: 14, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# الصوصات شامية' }, product: { name: 'راش قزعة' }, package: '650', packageUnit: { name: 'g' }, qty: 7, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# المقبلات' }, product: { name: 'حمص' }, package: '500', packageUnit: { name: 'g' }, qty: 10, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# المقبلات' }, product: { name: 'بابا غنوج' }, package: '500', packageUnit: { name: 'g' }, qty: 8, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# المقبلات' }, product: { name: 'متبل' }, package: '500', packageUnit: { name: 'g' }, qty: 5, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# السلطات' }, product: { name: 'تبولة' }, package: '300', packageUnit: { name: 'g' }, qty: 15, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# السلطات' }, product: { name: 'فتوش' }, package: '300', packageUnit: { name: 'g' }, qty: 12, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# السلطات' }, product: { name: 'سلطة يونانية' }, package: '300', packageUnit: { name: 'g' }, qty: 9, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# المشروبات' }, product: { name: 'عصير ليمون' }, package: '250', packageUnit: { name: 'ml' }, qty: 20, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# المشروبات' }, product: { name: 'عصير برتقال' }, package: '250', packageUnit: { name: 'ml' }, qty: 18, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# المشروبات' }, product: { name: 'عصير مانجو' }, package: '250', packageUnit: { name: 'ml' }, qty: 15, isSend: false }
                ]
            };
            
            processProductionData(sampleData);
            showMessage('production', '✅ بيانات تجريبية - 6 فئات', 'success');
        }

        function loadSampleSupplyData() {
            let sampleData = {
                data: [
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# خضروات' }, product: { name: 'طماطم' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 50, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# خضروات' }, product: { name: 'طماطم' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 30, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# خضروات' }, product: { name: 'طماطم' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 20, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# خضروات' }, product: { name: 'خيار' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 40, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# فواكه' }, product: { name: 'تفاح' }, package: '5', packageUnit: { name: 'كيلو' }, qty: 30, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# فواكه' }, product: { name: 'موز' }, package: '3', packageUnit: { name: 'كيلو' }, qty: 25, isSend: false },
                    { branch: { name: 'M شوران' }, mainProductOP: { name: '# ألبان' }, product: { name: 'جبنة بيضاء' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 20, isSend: false },
                    { branch: { name: 'S سلطانة' }, mainProductOP: { name: '# ألبان' }, product: { name: 'لبنة' }, package: '500', packageUnit: { name: 'g' }, qty: 15, isSend: false },
                    { branch: { name: 'A عزيزية' }, mainProductOP: { name: '# ألبان' }, product: { name: 'زبادي' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 12, isSend: false }
                ]
            };
            
            processSupplyData(sampleData);
            showMessage('supply', '✅ بيانات تجريبية', 'success');
        }

        function processProductionData(data) {
            let items = [];
            let branches = new Set();
            
            (data.data || []).forEach(item => {
                if (!item.isSend) {
                    items.push({
                        name: item.product?.name || 'منتج',
                        package: item.package || '',
                        packageUnit: item.packageUnit?.name || '',
                        qty: parseFloat(item.qty) || 0,
                        category: item.mainProductOP?.name || 'غير مصنف',
                        branch: item.branch?.name || 'فرع'
                    });
                    branches.add(item.branch?.name || 'فرع');
                }
            });
            
            appState.production.items = items;
            appState.production.allBranches = sortBranches(Array.from(branches));
            updateBranchFilter('production');
            filterItems('production');
            $('#empty-state-production').addClass('hidden');
        }

        function processSupplyData(data) {
            let items = [];
            let branches = new Set();
            
            (data.data || []).forEach(item => {
                if (!item.isSend) {
                    items.push({
                        name: item.product?.name || 'منتج',
                        package: item.package || '',
                        packageUnit: item.packageUnit?.name || '',
                        qty: parseFloat(item.qty) || 0,
                        category: item.mainProductOP?.name || 'غير مصنف',
                        branch: item.branch?.name || 'فرع'
                    });
                    branches.add(item.branch?.name || 'فرع');
                }
            });
            
            appState.supply.items = items;
            appState.supply.allBranches = sortBranches(Array.from(branches));
            updateBranchFilter('supply');
            filterItems('supply');
            $('#empty-state-supply').addClass('hidden');
        }

        function updateBranchFilter(type) {
            let select = $(`#branch-filter-${type}`);
            select.empty().append('<option value="">كل الفروع</option>');
            appState[type].allBranches.forEach(b => {
                let displayName = BRANCH_NAMES[b.charAt(0)] || b;
                select.append(`<option value="${b}">${displayName}</option>`);
            });
        }

        function filterItems(type) {
            let state = appState[type];
            if (state.selectedBranch) {
                state.filteredItems = state.items.filter(i => i.branch === state.selectedBranch);
            } else {
                state.filteredItems = [...state.items];
            }
            renderData(type);
        }

        function renderData(type) {
            let container = type === 'production' ? $('#production-data') : $('#supply-data');
            let state = appState[type];
            
            if (state.filteredItems.length === 0) {
                $(`#empty-state-${type}`).removeClass('hidden');
                container.addClass('hidden');
                return;
            }
            
            $(`#empty-state-${type}`).addClass('hidden');
            container.removeClass('hidden');
            
            let categories = {};
            state.filteredItems.forEach(item => {
                if (!categories[item.category]) categories[item.category] = [];
                categories[item.category].push(item);
            });
            
            let categoryList = Object.keys(categories);
            
            // توزيع الفئات على عمودين بالتساوي
            let firstHalf = [];
            let secondHalf = [];
            
            categoryList.forEach((cat, index) => {
                if (index % 2 === 0) {
                    firstHalf.push(cat);
                } else {
                    secondHalf.push(cat);
                }
            });
            
            let html = `
                <div class="split-view">
                    <div class="column">
                        <div class="column-header">القسم (1)</div>
                        <div class="column-content">
                            ${firstHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                        </div>
                    </div>
                    <div class="column">
                        <div class="column-header">القسم (2)</div>
                        <div class="column-content">
                            ${secondHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            container.html(html);
        }

        function buildCompactTable(category, items) {
            let branchesSet = new Set(items.map(item => item.branch));
            let allBranchesInItems = sortBranches(Array.from(branchesSet));
            
            let products = {};
            items.forEach(item => {
                let key = item.name + '-' + item.package + '-' + item.packageUnit;
                if (!products[key]) {
                    products[key] = {
                        name: item.name,
                        package: item.package,
                        packageUnit: item.packageUnit,
                        branches: {}
                    };
                    allBranchesInItems.forEach(branch => {
                        products[key].branches[branch] = 0;
                    });
                }
                products[key].branches[item.branch] = (products[key].branches[item.branch] || 0) + item.qty;
            });
            
            let productList = Object.values(products).sort((a, b) => a.name.localeCompare(b.name));
            
            let branchHeaders = '';
            allBranchesInItems.forEach(branch => {
                let displayName = BRANCH_NAMES[branch.charAt(0)] || branch;
                branchHeaders += `<th>${displayName}</th>`;
            });
            
            return `
                <div class="card">
                    <div class="card-header">${category}</div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="production-table">
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        ${branchHeaders}
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productList.map(p => {
                                        let total = 0;
                                        let branchCells = '';
                                        
                                        allBranchesInItems.forEach(branch => {
                                            let qty = p.branches[branch] || 0;
                                            total += qty;
                                            branchCells += `<td>${qty || '-'}</td>`;
                                        });
                                        
                                        return `
                                            <tr>
                                                <td style="text-align:left;">
                                                    <div class="product-name">${p.name}</div>
                                                    <div class="product-package">${p.package || ''} ${p.packageUnit || ''}</div>
                                                </td>
                                                ${branchCells}
                                                <td class="total-cell">${total || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function printAllTables(type) {
            let state = appState[type];
            
            if (state.filteredItems.length === 0) {
                alert('لا توجد بيانات للطباعة');
                return;
            }
            
            let categories = {};
            state.filteredItems.forEach(item => {
                if (!categories[item.category]) categories[item.category] = [];
                categories[item.category].push(item);
            });
            
            let categoryList = Object.keys(categories);
            let title = type === 'production' ? 'تقرير الإنتاج' : 'تقرير التوريد';
            let date = new Date().toLocaleDateString('ar-EG');
            
            // تقسيم الفئات إلى مجموعتين للصفحتين
            let halfSize = Math.ceil(categoryList.length / 2);
            let page1Categories = categoryList.slice(0, halfSize);
            let page2Categories = categoryList.slice(halfSize);
            
            // توزيع كل صفحة على عمودين
            let page1FirstHalf = [];
            let page1SecondHalf = [];
            page1Categories.forEach((cat, index) => {
                if (index % 2 === 0) {
                    page1FirstHalf.push(cat);
                } else {
                    page1SecondHalf.push(cat);
                }
            });
            
            let page2FirstHalf = [];
            let page2SecondHalf = [];
            page2Categories.forEach((cat, index) => {
                if (index % 2 === 0) {
                    page2FirstHalf.push(cat);
                } else {
                    page2SecondHalf.push(cat);
                }
            });
            
            let printContent = `
                <html dir="ltr">
                <head>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin:0; padding:0; box-sizing:border-box; font-family:Cairo; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
                        body { background:white; margin:0; padding:0; direction:ltr; }
                        .print-page { page-break-after:always; margin:0; padding:0; }
                        .split-view { display:flex; gap:3mm; margin:0; padding:0; page-break-after:avoid; }
                        .column { flex:1; margin:0; padding:0; page-break-inside:avoid; }
                        .column-content { margin:0; padding:0; page-break-inside:avoid; }
                        .column-header { background:#2E5E3A !important; color:white !important; padding:2px 4px; text-align:center; font-size:12px; margin:0; font-weight:600; page-break-after:avoid; }
                        .card { border:0.5px solid black !important; margin:0; padding:0; page-break-inside:avoid; border-top-width:0.5px; border-bottom-width:0; }
                        .card + .card { margin-top:-0.5px; border-top:0.5px solid black !important; }
                        .column-content .card:last-child { border-bottom:0.5px solid black !important; }
                        .card-header { background:#d0d8d0 !important; padding:2px 4px; text-align:center; font-weight:600; font-size:11px; border-bottom:0.5px solid black !important; margin:0; }
                        .production-table { width:100%; border-collapse:collapse; font-size:10px !important; margin:0; }
                        .production-table th, .production-table td { border:0.5px solid black !important; padding:2px 2px !important; text-align:center; font-size:10px !important; }
                        .production-table th:first-child, .production-table td:first-child { text-align:left; width:35%; }
                        .production-table th { background:#e0e0e0 !important; font-weight:600 !important; padding:2px !important; }
                        .product-name { font-size:10px !important; font-weight:500; }
                        .product-package { font-size:8px !important; color:#333; }
                        .total-cell { background:#d0d0d0 !important; font-weight:600 !important; }
                        .column-content, .card, .card-body, .table-container, 
                        .production-table, tbody, tr, td, th {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }
                        @page { size:A4 landscape; margin:3mm; }
                    </style>
                </head>
                <body>
            `;
            
            // الصفحة الأولى
            printContent += `
                <div class="print-page">
                    <div style="text-align:center; margin-bottom:1mm; font-size:12px; font-weight:600;">${title} - ${date} (الصفحة 1/2)</div>
                    <div class="split-view">
                        <div class="column">
                            <div class="column-header">القسم (1)</div>
                            <div class="column-content">
                                ${page1FirstHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                            </div>
                        </div>
                        <div class="column">
                            <div class="column-header">القسم (2)</div>
                            <div class="column-content">
                                ${page1SecondHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // الصفحة الثانية إذا يوجد فئات
            if (page2Categories.length > 0) {
                printContent += `
                    <div class="print-page">
                        <div style="text-align:center; margin-bottom:1mm; font-size:12px; font-weight:600;">${title} - ${date} (الصفحة 2/2)</div>
                        <div class="split-view">
                            <div class="column">
                                <div class="column-header">القسم (1)</div>
                                <div class="column-content">
                                    ${page2FirstHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                                </div>
                            </div>
                            <div class="column">
                                <div class="column-header">القسم (2)</div>
                                <div class="column-content">
                                    ${page2SecondHalf.map(cat => buildCompactTable(cat, categories[cat])).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            printContent += `</body></html>`;
            
            let printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 200);
        }

        function showMessage(type, message, messageType) {
            let container = $(`#message-container-${type}`);
            let className = messageType === 'success' ? 'success-message' : 
                           messageType === 'error' ? 'error-message' : 'warning-message';
            container.html(`<div class="message ${className}">${message}</div>`);
            setTimeout(() => container.empty(), 3000);
        }
    </script>
</body>
</html>
