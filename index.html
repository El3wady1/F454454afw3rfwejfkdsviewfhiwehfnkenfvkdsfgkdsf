<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salad Factory System - نظام مصنع السلطة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* إعادة تعيين كل الهوامش والمسافات */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            direction: rtl;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }

        /* Header Styles - Medium size */
        .header {
            background-color: #2E5E3A;
            color: white;
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #E6B905;
            color: #2E5E3A;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-btn:hover {
            background: #d4a900;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Navigation Tabs - Medium size */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-bottom: 2px solid #ccc;
            position: sticky;
            top: 48px;
            z-index: 999;
        }

        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .nav-tab.active {
            border-bottom-color: #2E5E3A;
            color: #2E5E3A;
        }

        .nav-tab:hover {
            background-color: rgba(46, 94, 58, 0.05);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 90px);
            overflow: hidden;
        }

        /* Print Controls */
        .print-controls {
            background-color: white;
            padding: 8px 12px;
            margin: 5px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 2px solid #eee;
        }

        .print-btn {
            background: #2E5E3A;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .print-btn:hover {
            background: #1e4a2a;
        }

        .print-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Filter Section */
        .filter-section {
            background-color: white;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-bottom: 2px solid #eee;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #2E5E3A;
            margin-bottom: 3px;
        }

        .branch-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #8B9E7E;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
        }

        .branch-select:focus {
            outline: none;
            border-color: #2E5E3A;
        }

        /* Data Container */
        .data-container {
            flex: 1;
            overflow: auto;
            padding: 5px;
        }

        /* ===== أنماط الجداول المدمجة بالكامل ===== */
        .card {
            background-color: white;
            margin: 8px 0;
            border: 1px solid #888;
            border-radius: 4px;
            overflow: hidden;
        }

        .card-header {
            background-color: #e0e8e0;
            padding: 6px 10px;
            font-weight: 700;
            font-size: 16px;
            color: #2E5E3A;
            text-align: center;
            border-bottom: 1px solid #888;
        }

        .card-body {
            padding: 0;
        }

        .table-container {
            overflow-x: auto;
        }

        /* جدول مدمج - حجم خط متوسط */
        .production-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            font-size: 13px;
            line-height: 1.3;
        }

        /* مسافات مناسبة للخلايا */
        .production-table th,
        .production-table td {
            border: 1px solid #888;
            padding: 4px 6px;
            margin: 0;
            text-align: center;
            vertical-align: middle;
            font-size: 13px;
        }

        /* العمود الأول (المنتجات) */
        .production-table th:first-child,
        .production-table td:first-child {
            text-align: right;
            padding: 4px 8px;
            min-width: 150px;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }

        /* رأس الجدول */
        .production-table th {
            background-color: #e8e8e8;
            font-weight: 700;
            color: #2E5E3A;
            white-space: nowrap;
        }

        /* خلية الإجمالي */
        .total-cell {
            background-color: #f0f0f0;
            font-weight: 700;
        }

        /* معلومات المنتج */
        .product-name {
            font-weight: 600;
            line-height: 1.3;
            white-space: normal;
            word-wrap: break-word;
            font-size: 13px;
        }

        .product-package {
            font-size: 11px;
            color: #666;
            line-height: 1.2;
        }

        /* عناوين الفروع */
        .branch-header {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
        }

        /* ===== أنماط الطباعة ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
                margin: 0;
                padding: 2mm;
            }
            
            .main-content {
                height: auto;
                overflow: visible;
            }
            
            .data-container {
                overflow: visible;
                padding: 0;
            }
            
            .card {
                margin: 1mm 0;
                border: 0.5px solid black;
                page-break-inside: avoid;
            }
            
            .card-header {
                padding: 2px 4px;
                font-size: 12px;
                border-bottom: 0.5px solid black;
            }
            
            .production-table {
                font-size: 10px;
                line-height: 1.2;
                border-collapse: collapse;
            }
            
            .production-table th,
            .production-table td {
                border: 0.3px solid black;
                padding: 2px 3px;
                font-size: 10px;
            }
            
            .production-table th:first-child,
            .production-table td:first-child {
                padding: 2px 4px;
                min-width: 100px;
            }
            
            .product-name {
                font-size: 10px;
            }
            
            .product-package {
                font-size: 8px;
            }
            
            .branch-header {
                font-size: 8px;
                max-width: 30px;
            }
            
            .print-page {
                page-break-after: always;
                margin: 0;
                padding: 1mm;
            }
            
            @page {
                size: A4 landscape;
                margin: 3mm;
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 10px;
        }

        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(46, 94, 58, 0.2);
            border-left: 3px solid #2E5E3A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 250px;
            text-align: center;
        }

        .empty-icon {
            font-size: 50px;
            color: #8B9E7E;
            margin-bottom: 10px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .empty-state p {
            font-size: 14px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        /* Messages */
        .message {
            padding: 8px 12px;
            margin: 5px 0;
            font-size: 14px;
            border-radius: 5px;
        }

        .success-message { 
            background: #efe; 
            color: #363; 
            border: 1px solid #cfc; 
        }
        
        .error-message { 
            background: #fee; 
            color: #c33; 
            border: 1px solid #fcc; 
        }
        
        .warning-message { 
            background: #ffecb5; 
            color: #7d6608; 
            border: 1px solid #ffd54f; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8B9E7E;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2E5E3A;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .d-flex { display: flex; }
        .gap-5 { gap: 5px; }
        .mt-5 { margin-top: 5px; }
        .mb-5 { margin-bottom: 5px; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header no-print">
        <div class="container">
            <div class="header-content">
                <button id="refresh-btn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> <span>تحديث البيانات</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="nav-tabs no-print">
        <div class="nav-tab active" data-tab="production">
            <i class="fas fa-industry"></i> <span>الإنتاج</span>
        </div>
        <div class="nav-tab" data-tab="supply">
            <i class="fas fa-truck-loading"></i> <span>توريد</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Production Tab -->
        <div id="production-tab" class="tab-content">
            <div class="main-content">
                <!-- Print Controls -->
                <div class="print-controls no-print">
                    <button id="print-all-production" class="print-btn">
                        <i class="fas fa-print"></i> طباعة الكل
                    </button>
                    <button id="load-sample-production" class="print-btn" style="background:#8B9E7E;">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>

                <!-- Filter -->
                <div class="filter-section no-print">
                    <label class="filter-label">الفرع:</label>
                    <select id="branch-filter-production" class="branch-select">
                        <option value="">كل الفروع</option>
                    </select>
                </div>

                <!-- Messages -->
                <div id="message-container-production"></div>

                <!-- Data Container -->
                <div class="data-container" id="scroll-container-production">
                    <!-- Loading -->
                    <div id="loading-state-production" class="loading-spinner">
                        <div class="spinner"></div>
                        <span>جاري تحميل بيانات الإنتاج...</span>
                    </div>

                    <!-- Empty -->
                    <div id="empty-state-production" class="empty-state hidden">
                        <div class="empty-icon"><i class="fas fa-industry"></i></div>
                        <h3>لا توجد بيانات</h3>
                        <p>لم يتم العثور على بيانات من API</p>
                        <button id="try-sample-production" class="print-btn" style="margin-top:5px; background:#2E5E3A;">عرض بيانات تجريبية</button>
                    </div>

                    <!-- Data -->
                    <div id="production-data" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- Supply Tab -->
        <div id="supply-tab" class="tab-content hidden">
            <div class="main-content">
                <!-- Print Controls -->
                <div class="print-controls no-print">
                    <button id="print-all-supply" class="print-btn">
                        <i class="fas fa-print"></i> طباعة الكل
                    </button>
                    <button id="load-sample-supply" class="print-btn" style="background:#8B9E7E;">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>

                <!-- Filter -->
                <div class="filter-section no-print">
                    <label class="filter-label">الفرع:</label>
                    <select id="branch-filter-supply" class="branch-select">
                        <option value="">كل الفروع</option>
                    </select>
                </div>

                <!-- Messages -->
                <div id="message-container-supply"></div>

                <!-- Data Container -->
                <div class="data-container" id="scroll-container-supply">
                    <!-- Loading -->
                    <div id="loading-state-supply" class="loading-spinner">
                        <div class="spinner"></div>
                        <span>جاري تحميل بيانات التوريد...</span>
                    </div>

                    <!-- Empty -->
                    <div id="empty-state-supply" class="empty-state hidden">
                        <div class="empty-icon"><i class="fas fa-truck-loading"></i></div>
                        <h3>لا توجد بيانات</h3>
                        <p>لم يتم العثور على بيانات من API</p>
                        <button id="try-sample-supply" class="print-btn" style="margin-top:5px; background:#2E5E3A;">عرض بيانات تجريبية</button>
                    </div>

                    <!-- Data -->
                    <div id="supply-data" class="hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // حالة التطبيق
        let appState = {
            currentTab: 'production',
            production: {
                items: [],
                filteredItems: [],
                allBranches: [],
                selectedBranch: '',
                apiUrl: 'https://ramadanv2026-production.up.railway.app/api/orderProduction/getOrderPof2Days',
                isLoading: false,
                useSampleData: false
            },
            supply: {
                items: [],
                filteredItems: [],
                allBranches: [],
                selectedBranch: '',
                apiUrl: 'https://ramadanv2026-production.up.railway.app/api/orderSupply/getOrderPof2Days',
                isLoading: false,
                useSampleData: false
            }
        };

        $(document).ready(function() {
            loadProductionData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // تبديل التبويبات
            $('.nav-tab').click(function() {
                let tab = $(this).data('tab');
                $('.nav-tab').removeClass('active');
                $(this).addClass('active');
                $('.tab-content').addClass('hidden');
                $(`#${tab}-tab`).removeClass('hidden');
                appState.currentTab = tab;
            });

            // فلتر الفروع للإنتاج
            $('#branch-filter-production').change(function() {
                appState.production.selectedBranch = $(this).val() || '';
                filterItems('production');
            });

            // فلتر الفروع للتوريد
            $('#branch-filter-supply').change(function() {
                appState.supply.selectedBranch = $(this).val() || '';
                filterItems('supply');
            });

            // زر التحديث
            $('#refresh-btn').click(function() {
                if (appState.currentTab === 'production') {
                    loadProductionData();
                } else {
                    loadSupplyData();
                }
            });

            // أزرار البيانات التجريبية
            $('#load-sample-production, #try-sample-production').click(function() {
                loadSampleProductionData();
            });

            $('#load-sample-supply, #try-sample-supply').click(function() {
                loadSampleSupplyData();
            });

            // أزرار الطباعة
            $('#print-all-production').click(() => printAllTables('production'));
            $('#print-all-supply').click(() => printAllTables('supply'));
        }

        // تحميل بيانات الإنتاج من API
        async function loadProductionData() {
            if (appState.production.isLoading) return;
            
            appState.production.isLoading = true;
            appState.production.useSampleData = false;
            $('#loading-state-production').removeClass('hidden');
            $('#production-data').addClass('hidden');
            $('#empty-state-production').addClass('hidden');
            $('#refresh-btn').prop('disabled', true);

            try {
                console.log('جاري تحميل بيانات الإنتاج من:', appState.production.apiUrl);
                
                // محاولة الاتصال المباشر أولاً
                try {
                    const response = await fetch(appState.production.apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('بيانات الإنتاج المستلمة (مباشر):', data);
                        
                        if (data.status === 200 && data.data && data.data.length > 0) {
                            processProductionData(data);
                            showMessage('production', '✅ تم تحميل بيانات الإنتاج بنجاح', 'success');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('فشل الاتصال المباشر، جرب proxy:', e);
                }

                // استخدام proxy
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + appState.production.apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }

                const data = await response.json();
                console.log('بيانات الإنتاج المستلمة (proxy):', data);

                if (data.status === 200 && data.data && data.data.length > 0) {
                    processProductionData(data);
                    showMessage('production', '✅ تم تحميل بيانات الإنتاج بنجاح', 'success');
                } else {
                    showMessage('production', '⚠️ لا توجد بيانات في API، استخدم البيانات التجريبية', 'warning');
                    $('#empty-state-production').removeClass('hidden');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات الإنتاج:', error);
                showMessage('production', '❌ فشل الاتصال بالخادم: ' + error.message, 'error');
                $('#empty-state-production').removeClass('hidden');
            } finally {
                appState.production.isLoading = false;
                $('#loading-state-production').addClass('hidden');
                $('#refresh-btn').prop('disabled', false);
            }
        }

        // تحميل بيانات التوريد من API
        async function loadSupplyData() {
            if (appState.supply.isLoading) return;
            
            appState.supply.isLoading = true;
            appState.supply.useSampleData = false;
            $('#loading-state-supply').removeClass('hidden');
            $('#supply-data').addClass('hidden');
            $('#empty-state-supply').addClass('hidden');
            $('#refresh-btn').prop('disabled', true);

            try {
                console.log('جاري تحميل بيانات التوريد من:', appState.supply.apiUrl);
                
                // محاولة الاتصال المباشر أولاً
                try {
                    const response = await fetch(appState.supply.apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('بيانات التوريد المستلمة (مباشر):', data);
                        
                        if (data.status === 200 && data.data && data.data.length > 0) {
                            processSupplyData(data);
                            showMessage('supply', '✅ تم تحميل بيانات التوريد بنجاح', 'success');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('فشل الاتصال المباشر، جرب proxy:', e);
                }

                // استخدام proxy
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + appState.supply.apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة: ${response.status}`);
                }

                const data = await response.json();
                console.log('بيانات التوريد المستلمة (proxy):', data);

                if (data.status === 200 && data.data && data.data.length > 0) {
                    processSupplyData(data);
                    showMessage('supply', '✅ تم تحميل بيانات التوريد بنجاح', 'success');
                } else {
                    showMessage('supply', '⚠️ لا توجد بيانات في API، استخدم البيانات التجريبية', 'warning');
                    $('#empty-state-supply').removeClass('hidden');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات التوريد:', error);
                showMessage('supply', '❌ فشل الاتصال بالخادم: ' + error.message, 'error');
                $('#empty-state-supply').removeClass('hidden');
            } finally {
                appState.supply.isLoading = false;
                $('#loading-state-supply').addClass('hidden');
                $('#refresh-btn').prop('disabled', false);
            }
        }

        // تحميل بيانات تجريبية للإنتاج
        function loadSampleProductionData() {
            appState.production.useSampleData = true;
            
            let sampleData = {
                data: [
                    // سلطات - فرع مكة
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة سيزر كلاسيك' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 5, isSend: false },
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة يونانية تقليدية' }, package: '500', packageUnit: { name: 'جرام' }, qty: 3, isSend: false },
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة خضراء مشكلة' }, package: '750', packageUnit: { name: 'جرام' }, qty: 4, isSend: false },
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة تبولة' }, package: '400', packageUnit: { name: 'جرام' }, qty: 6, isSend: false },
                    
                    // سلطات - فرع جدة
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة سيزر كلاسيك' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 7, isSend: false },
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة خضراء مشكلة' }, package: '750', packageUnit: { name: 'جرام' }, qty: 4, isSend: false },
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة يونانية تقليدية' }, package: '500', packageUnit: { name: 'جرام' }, qty: 6, isSend: false },
                    
                    // سلطات - فرع المدينة
                    { branch: { name: 'المدينة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة سيزر كلاسيك' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 2, isSend: false },
                    { branch: { name: 'المدينة' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة خضراء مشكلة' }, package: '750', packageUnit: { name: 'جرام' }, qty: 6, isSend: false },
                    
                    // سلطات - فرع الرياض
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة سيزر كلاسيك' }, package: '1', packageUnit: { name: 'كيلو' }, qty: 8, isSend: false },
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة يونانية تقليدية' }, package: '500', packageUnit: { name: 'جرام' }, qty: 5, isSend: false },
                    
                    // سلطات - فرع الدمام
                    { branch: { name: 'الدمام' }, mainProductOP: { name: 'سلطات' }, product: { name: 'سلطة خضراء مشكلة' }, package: '750', packageUnit: { name: 'جرام' }, qty: 5, isSend: false },
                    
                    // مقبلات - فرع الرياض
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'حمص بالطحينة' }, package: '500', packageUnit: { name: 'جرام' }, qty: 10, isSend: false },
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'متبل باذنجان' }, package: '500', packageUnit: { name: 'جرام' }, qty: 8, isSend: false },
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'بابا غنوج' }, package: '500', packageUnit: { name: 'جرام' }, qty: 5, isSend: false },
                    
                    // مقبلات - فرع الدمام
                    { branch: { name: 'الدمام' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'حمص بالطحينة' }, package: '500', packageUnit: { name: 'جرام' }, qty: 5, isSend: false },
                    { branch: { name: 'الدمام' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'بابا غنوج' }, package: '500', packageUnit: { name: 'جرام' }, qty: 7, isSend: false },
                    
                    // مقبلات - فرع مكة
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'حمص بالطحينة' }, package: '500', packageUnit: { name: 'جرام' }, qty: 12, isSend: false },
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'متبل باذنجان' }, package: '500', packageUnit: { name: 'جرام' }, qty: 9, isSend: false },
                    
                    // مقبلات - فرع جدة
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'بابا غنوج' }, package: '500', packageUnit: { name: 'جرام' }, qty: 6, isSend: false },
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'مقبلات' }, product: { name: 'حمص بالطحينة' }, package: '500', packageUnit: { name: 'جرام' }, qty: 8, isSend: false }
                ]
            };
            
            processProductionData(sampleData);
            showMessage('production', '✅ تم تحميل بيانات تجريبية', 'success');
        }

        // تحميل بيانات تجريبية للتوريد
        function loadSampleSupplyData() {
            appState.supply.useSampleData = true;
            
            let sampleData = {
                data: [
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'خضروات' }, product: { name: 'طماطم' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 50, isSend: false },
                    { branch: { name: 'مكة' }, mainProductOP: { name: 'خضروات' }, product: { name: 'خيار' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 40, isSend: false },
                    { branch: { name: 'جدة' }, mainProductOP: { name: 'خضروات' }, product: { name: 'طماطم' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 60, isSend: false },
                    { branch: { name: 'الرياض' }, mainProductOP: { name: 'فواكه' }, product: { name: 'برتقال' }, package: '10', packageUnit: { name: 'كيلو' }, qty: 30, isSend: false }
                ]
            };
            
            processSupplyData(sampleData);
            showMessage('supply', '✅ تم تحميل بيانات تجريبية', 'success');
        }

        // معالجة بيانات الإنتاج
        function processProductionData(data) {
            let items = [];
            let branches = new Set();
            
            (data.data || []).forEach(item => {
                if (!item.isSend) {
                    let productName = item.product?.name || 'منتج بدون اسم';
                    let packageInfo = item.package || '';
                    let packageUnit = item.packageUnit?.name || '';
                    let categoryName = item.mainProductOP?.name || 'غير مصنف';
                    let branchName = item.branch?.name || 'فرع غير معروف';
                    let quantity = parseFloat(item.qty) || 0;
                    
                    items.push({
                        name: productName,
                        package: packageInfo,
                        packageUnit: packageUnit,
                        qty: quantity,
                        category: categoryName,
                        branch: branchName
                    });
                    
                    branches.add(branchName);
                }
            });
            
            appState.production.items = items;
            appState.production.allBranches = Array.from(branches).sort();
            
            updateBranchFilter('production');
            filterItems('production');
            
            $('#empty-state-production').addClass('hidden');
        }

        // معالجة بيانات التوريد
        function processSupplyData(data) {
            let items = [];
            let branches = new Set();
            
            (data.data || []).forEach(item => {
                if (!item.isSend) {
                    let productName = item.product?.name || 'منتج بدون اسم';
                    let packageInfo = item.package || '';
                    let packageUnit = item.packageUnit?.name || '';
                    let categoryName = item.mainProductOP?.name || 'غير مصنف';
                    let branchName = item.branch?.name || 'فرع غير معروف';
                    let quantity = parseFloat(item.qty) || 0;
                    
                    items.push({
                        name: productName,
                        package: packageInfo,
                        packageUnit: packageUnit,
                        qty: quantity,
                        category: categoryName,
                        branch: branchName
                    });
                    
                    branches.add(branchName);
                }
            });
            
            appState.supply.items = items;
            appState.supply.allBranches = Array.from(branches).sort();
            
            updateBranchFilter('supply');
            filterItems('supply');
            
            $('#empty-state-supply').addClass('hidden');
        }

        // تحديث فلتر الفروع
        function updateBranchFilter(type) {
            let select = $(`#branch-filter-${type}`);
            select.empty().append('<option value="">كل الفروع</option>');
            appState[type].allBranches.forEach(b => {
                select.append(`<option value="${b}">${b}</option>`);
            });
        }

        // تصفية العناصر
        function filterItems(type) {
            let state = appState[type];
            if (state.selectedBranch) {
                state.filteredItems = state.items.filter(i => i.branch === state.selectedBranch);
            } else {
                state.filteredItems = [...state.items];
            }
            renderData(type);
        }

        // عرض البيانات
        function renderData(type) {
            let container = type === 'production' ? $('#production-data') : $('#supply-data');
            let state = appState[type];
            
            if (state.filteredItems.length === 0) {
                $(`#empty-state-${type}`).removeClass('hidden');
                container.addClass('hidden');
                return;
            }
            
            $(`#empty-state-${type}`).addClass('hidden');
            container.removeClass('hidden');
            
            // تنظيم حسب الفئة
            let categories = {};
            state.filteredItems.forEach(item => {
                if (!categories[item.category]) categories[item.category] = [];
                categories[item.category].push(item);
            });
            
            let branches = state.selectedBranch ? [state.selectedBranch] : state.allBranches;
            
            let html = '';
            for (let cat in categories) {
                html += buildCompactTable(cat, categories[cat], branches);
            }
            
            container.html(html);
        }

        // بناء جدول مدمج
        function buildCompactTable(category, items, allBranches) {
            // تجميع المنتجات
            let products = {};
            items.forEach(item => {
                let key = item.name + '-' + item.package + '-' + item.packageUnit;
                if (!products[key]) {
                    products[key] = {
                        name: item.name,
                        package: item.package,
                        packageUnit: item.packageUnit,
                        branches: {}
                    };
                }
                products[key].branches[item.branch] = (products[key].branches[item.branch] || 0) + item.qty;
            });
            
            let productList = Object.values(products).sort((a, b) => a.name.localeCompare(b.name));
            
            // بناء الجدول
            let table = `
                <div class="card">
                    <div class="card-header">${category}</div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="production-table" cellspacing="0" cellpadding="0">
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        ${allBranches.map(b => `<th class="branch-header" title="${b}">${shortenBranchName(b)}</th>`).join('')}
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productList.map(p => {
                                        let total = 0;
                                        return `
                                            <tr>
                                                <td style="text-align:right;">
                                                    <div class="product-name">${p.name}</div>
                                                    <div class="product-package">${p.package || ''} ${p.packageUnit || ''}</div>
                                                </td>
                                                ${allBranches.map(b => {
                                                    let val = p.branches[b] || '-';
                                                    if (val !== '-') total += val;
                                                    return `<td>${val}</td>`;
                                                }).join('')}
                                                <td class="total-cell">${total || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            return table;
        }

        // اختصار اسم الفرع
        function shortenBranchName(name) {
            if (name.length <= 6) return name;
            let parts = name.split(' ');
            if (parts.length > 1) {
                return parts.map(p => p.substring(0, 2)).join('');
            }
            return name.substring(0, 4);
        }

        // طباعة جميع الجداول
        function printAllTables(type) {
            let state = appState[type];
            
            if (state.filteredItems.length === 0) {
                alert('لا توجد بيانات للطباعة');
                return;
            }
            
            // تنظيم حسب الفئة
            let categories = {};
            state.filteredItems.forEach(item => {
                if (!categories[item.category]) categories[item.category] = [];
                categories[item.category].push(item);
            });
            
            let branches = state.selectedBranch ? [state.selectedBranch] : state.allBranches;
            let categoryList = Object.keys(categories);
            
            let title = type === 'production' ? 'تقرير الإنتاج' : 'تقرير التوريد';
            let date = new Date().toLocaleDateString('ar-SA');
            
            let printContent = `
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin:0; padding:0; box-sizing:border-box; font-family:Cairo; }
                        body { background:white; padding:2mm; }
                        .print-page { page-break-after: always; margin:0; padding:1mm; }
                        .card { border:0.5px solid black; margin:1mm 0; }
                        .card-header { background:#e0e8e0; padding:2px 4px; text-align:center; font-weight:bold; font-size:12px; border-bottom:0.5px solid black; }
                        .production-table { width:100%; border-collapse:collapse; font-size:10px; line-height:1.2; }
                        .production-table th, .production-table td { border:0.3px solid black; padding:2px 3px; text-align:center; }
                        .production-table th:first-child, .production-table td:first-child { text-align:right; min-width:100px; }
                        .product-name { font-weight:bold; font-size:10px; }
                        .product-package { font-size:8px; color:#666; }
                        .branch-header { font-size:8px; max-width:30px; overflow:hidden; }
                        .total-cell { background:#f0f0f0; font-weight:bold; }
                        @page { size:A4 landscape; margin:3mm; }
                    </style>
                </head>
                <body>
            `;
            
            // حساب عدد الفئات في كل صفحة (صفحتين كحد أقصى)
            let itemsPerPage = Math.ceil(categoryList.length / 2);
            
            for (let page = 0; page < categoryList.length; page += itemsPerPage) {
                printContent += '<div class="print-page">';
                printContent += `<div style="text-align:center; margin-bottom:1mm; font-size:12px; font-weight:bold;">${title} - ${date} - صفحة ${Math.floor(page/itemsPerPage)+1}</div>`;
                
                for (let i = page; i < page + itemsPerPage && i < categoryList.length; i++) {
                    let cat = categoryList[i];
                    printContent += buildCompactTable(cat, categories[cat], branches);
                }
                
                printContent += '</div>';
            }
            
            printContent += '</body></html>';
            
            let printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // عرض الرسائل
        function showMessage(type, message, messageType = 'info') {
            let container = $(`#message-container-${type}`);
            let className = messageType === 'success' ? 'success-message' : 
                           messageType === 'error' ? 'error-message' : 'warning-message';
            
            container.html(`<div class="message ${className}">${message}</div>`);
            
            setTimeout(() => {
                container.empty();
            }, 4000);
        }
    </script>
</body>
</html>
